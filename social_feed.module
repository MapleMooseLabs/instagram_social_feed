<?php

/**
 * @file
 * Defines all hooks and helper functions.
 */


/**
* Implementation of hook_menu()
*/
function social_feed_menu() {

  $items['ajax/social'] = array(
    'title' => 'Events',
    'page callback' => 'rmcad_social',
    'access callback' => TRUE,
    'type' => MENU_CALLBACK,
  );

  $items['social_overview'] = array(
    'title' => 'Social Overview',
    'page callback' => 'rmcad_social_overview',
    'access callback' => TRUE,
    'type' => MENU_CALLBACK,
  );

  $items['admin/settings/rmcad_social'] = array(
    'title' => 'Social Aggregator',
    'description' => 'Approve new items for site display',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('rmcad_social_admin'),
    'access arguments' => array('access administration pages'),
    'type' => MENU_NORMAL_ITEM,
  );

  $items['ajax/social_approve'] = array(
    'title' => 'Social Approve',
    'page callback' => 'rmcad_social_approve',
    'access callback' => TRUE,
    'type' => MENU_CALLBACK,
  );

  return $items;
}

function rmcad_social_overview() {

	global $user;
	if($user->uid < 1) {
		drupal_access_denied();
		exit();
	} else {
	}


	$sql = "SELECT * from social_instagram ORDER BY instagram_id DESC";
	$result = db_query($sql); ?>

	<div style="display:block; float:left; width:40%;">

	<?php
	foreach($result as $row): 
		$time = date('Y-m-d g:i a', $row->time);
	?>
		<div style="display:block; float:left; margin:10px; ">
		<a href="<?php print $row->instagram_link; ?>" target="_blank"><img src="<?php print $row->thumbnail; ?>" /></a><br>
		
		<input type="checkbox" onclick="approve('?instagram_id=<?php print $row->instagram_id; ?>')" <?php if($row->approve == "1"): ?> checked="checked" <?php endif; ?> />
		<b><?php print $row->instagram_user; ?></b><br> <?php print $time; ?>
		</div>

	<?php endforeach; ?>
	</div>

	<script type="text/javascript" src="/misc/jquery.js?v=1.4.4"></script>
	<script type="text/javascript">

		function approve(id) {
			jQuery.get('/ajax/social_approve' + id);
		}

	</script>


	<?php
}

function rmcad_social_approve($id) {

	$table = "";
	$column = "";

	if(isset($_GET['twitter_id'])) {
		$id = $_GET['twitter_id'];
		$table = "social_twitter";
		$column = "twitter_id";
	} else if(isset($_GET['instagram_id'])) {
		$id = $_GET['instagram_id'];
		$table = "social_instagram";
		$column = "instagram_id";
	} else {
		header("HTTP/1.1 500 Internal Server Error");
		exit();
	}
	
	$sql = "UPDATE $table SET approve = IF(approve=1, 0, 1); WHERE $column = $id LIMIT 1";
	$result = db_update($table)
		->expression(
			'approve', 'IF(approve=1, 0, 1)'
		)
		->condition(
			$column, $id
		)
		->execute(); 
	

}

function rmcad_social_admin() {

  ob_start();
  rmcad_social_overview();
  $output = ob_get_clean();

  $form = array();

  /*$form['onthisdate_maxdisp'] = array(
    '#type' => 'textfield',
    '#title' => t('Maximum number of links'),
    '#default_value' => variable_get('onthisdate_maxdisp', 3),
    '#size' => 2,
    '#maxlength' => 2,
    '#description' => t("The maximum number of links to display in the block."),
    '#required' => TRUE,
  );*/

  $form['iframecontent'] = array(
	'#markup' => $output,
  );

  $form = system_settings_form($form);

  unset($form['#submit']);
  unset($form['actions']);
	
  return $form;

}

function rmcad_social($page_num) {

	if(isset($_GET['page_num']))
		$page_num = $_GET['page_num'];
	else
		$page_num = 0;	

	//echo "PAGE NUM: $page_num";

	$count = 3;
	$page_num = $page_num * $count;

	$sql = "SELECT * FROM social_instagram WHERE approve = 1 ORDER BY instagram_id DESC LIMIT $page_num, $count";
	//echo $sql;
	$result = db_query($sql);
	$instagrams = array();
	foreach($result as $row) {
		$instagrams[] = $row;
	}

	$sql = "SELECT * FROM social_twitter WHERE approve = 1 ORDER BY twitter_id DESC LIMIT $page_num, $count";
	//echo $sql;
	$result = db_query($sql);
	$tweets = array();
	foreach($result as $row) {
		$tweets[] = $row;
	}
	?>

	<!-- TEMP SOCIAL FEED FIX -->
	<div class="clearfix active" id="homepage-activity-social">
	    <div class="item twitter">
		<header class="item-title">
		    <h6>Twitter</h6>
		</header>
		<div class="item-content">
		    <em><?php print $tweets[0]->tweet; ?></em>
		    <cite>&mdash; <a href="https://twitter.com/<?php print $tweets[0]->user_name; ?>" target="_blank">@<?php print $tweets[0]->user_name; ?></a></cite>
		</div>
	    </div>
	    <div class="item instagram">
		<header class="item-title">
		    <h6>Instagram</h6>
		</header>
		<div class="item-content">
		    <a target="_blank" href="<?php print $instagrams[0]->instagram_link; ?>"><img alt="Photo Title" height="150" src="<?php print $instagrams[0]->thumbnail; ?>" width="150" /></a>
		    <cite>&mdash; <a target="_blank" href="http://instagram.com/<?php print $instagrams[0]->instagram_user; ?>/">@<?php print $instagrams[0]->instagram_user; ?></a></cite>
		</div>
	    </div>
	    <div class="item twitter last">
		<header class="item-title">
		    <h6>Twitter</h6>
		</header>
		<div class="item-content">
		    <em><?php print $tweets[1]->tweet; ?></em>
		    <cite>&mdash; <a href="https://twitter.com/<?php print $tweets[1]->user_name; ?>" target="_blank">@<?php print $tweets[1]->user_name; ?></a></cite>
		</div>
	    </div>
	    <div class="item instagram">
		<header class="item-title">
		    <h6>Instagram</h6>
		</header>
		<div class="item-content">
		    <a target="_blank" href="<?php print $instagrams[1]->instagram_link; ?>"><img alt="Photo Title" height="150" src="<?php print $instagrams[1]->thumbnail; ?>" width="150" /></a>
		    <cite>&mdash; <a target="_blank" href="http://instagram.com/<?php print $instagrams[1]->instagram_user; ?>/">@<?php print $instagrams[1]->instagram_user; ?></a></cite>
		</div>
	    </div>
	    <div class="item twitter">
		<header class="item-title">
		    <h6>Twitter</h6>
		</header>
		<div class="item-content">
		    <em><?php print $tweets[2]->tweet; ?></em>
		    <cite>&mdash; <a href="https://twitter.com/<?php print $tweets[2]->user_name; ?>" target="_blank">@<?php print $tweets[2]->user_name; ?></a></cite>
		</div>
	    </div>
	    <div class="item instagram last">
		<header class="item-title">
		    <h6>Instagram</h6>
		</header>
		<div class="item-content">
		    <a target="_blank" href="<?php print $instagrams[2]->instagram_link; ?>"><img alt="Photo Title" height="150" src="<?php print $instagrams[2]->thumbnail; ?>" width="150" /></a>
		    <cite>&mdash; <a target="_blank" href="http://instagram.com/<?php print $instagrams[2]->instagram_user; ?>/">@<?php print $instagrams[2]->instagram_user; ?></a></cite>
		</div>
	    </div>
	</div>

	<?php
	
}


function stripslashes_deep($value) {
  $value = is_array($value) ?
    array_map('stripslashes_deep', $value) :
    stripslashes($value);

  return $value;
}

//Take input POST value and run against array. If there is a match
//between value and input the array key will be returned
function input_filter($input, $filter_array){
echo "Input Filter, input: $input\n";
	foreach ($filter_array as $key=>$value){
		echo "Key: $key, Value: $value\n";
		if($input == $key){
			echo "Found key $key\n";
			//return key of filter array that matches input
			return $key;
		}
	}
}

//Enter query to make CURL request to API
function api_call($query){
  $curl = curl_init();
  curl_setopt($curl, CURLOPT_URL, $query);
  curl_setopt($curl, CURLOPT_RETURNTRANSFER, 1);
  curl_setopt($curl, CURLOPT_SSL_VERIFYPEER, false);
  curl_setopt($curl, CURLOPT_TIMEOUT, 20);
  $result= curl_exec($curl);
  curl_close($curl);

  return $result;
}

function social_feed_cron() {

  $access_token = '30805250.1fb234f.27a3c29a8e8545caa31a7be52462c2fa';

  $tag = "rmcad";

  $table = 'social_instagram';
  $instagram_query = "https://api.instagram.com/v1/tags/$tag/media/recent?access_token=$access_token";

  $instagram_feed = json_decode(api_call($instagram_query));

   echo "<pre style='font-size:14px;'>";
   var_dump($instagram_feed);
   echo "</pre>";

   foreach($instagram_feed->data as $feed){
     //Check if instagram photo already exists based on unix timestamp
     $sql = "SELECT instagram_id FROM {$table} WHERE instagram_id = '{$feed->id}'";
     $result = db_query($sql);
     $count = $result->rowCount();

     //Comma deliminate hashtag array and return as string
     $tags = implode(",", $feed->tags);

      //If no duplicate time entries proceed
      if($count < 1){
        $data = array(
          'user_id' => $feed->user->id,
          'tags' => $tags,
          //Time stored in unix epoch format
          'time'=>$feed->created_time,
          'low_resolution' => $feed->images->low_resolution->url,
          'thumbnail' => $feed->images->thumbnail->url,
          'standard_resolution' => $feed->images->standard_resolution->url,
          'caption' => utf8_encode($feed->caption->text),
          'instagram_id' => $feed->id,
          'instagram_link' => $feed->link,
          'instagram_user' => $feed->user->username,
        );

        //Insert data into table
        $result = db_insert($table)->fields($data)->execute();

        $post = array(
          'post_author'    => 1,
          'post_content'   => $data['caption'],
          'post_name'      => 'instagram_'.$data->time,
          'post_parent'    => 0,
          'post_status'    => 'publish',
          'post_title'     => $data['caption'],
          'post_type'      => 'instagram'
        );
      }
   }
}
